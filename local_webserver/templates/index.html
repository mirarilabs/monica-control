<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monica Robotic Harmonica Control</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .status-bar {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .keyboard {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 30px 0;
        }
        .key-row {
            display: flex;
            margin: 5px 0;
            gap: 5px;
        }
        .key {
            width: 50px;
            height: 50px;
            background: white;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.1s;
            user-select: none;
        }
        .key:hover {
            background: #e0e0e0;
        }
        .key.active {
            background: #4CAF50;
            color: white;
            transform: scale(0.95);
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 12px 24px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #1976D2;
        }
        .btn.performance {
            background: #4CAF50;
        }
        .btn.performance:hover {
            background: #45a049;
        }
        .btn.home {
            background: #ff9800;
        }
        .btn.home:hover {
            background: #f57c00;
        }
        .info-panel {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
        }
        .info-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
        }
        .info-box h3 {
            margin-top: 0;
            color: #333;
        }
        .key-mapping {
            font-size: 14px;
            line-height: 1.5;
        }
        .connection-status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .connected {
            background: #d4edda;
            color: #155724;
        }
        .disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 14px;
        }
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 3% auto 5% auto;
            padding: 0;
            border-radius: 10px;
            width: 85%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: #2196F3;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
        }
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 15px;
        }
        .modal-footer {
            padding: 15px;
            text-align: right;
            border-top: 1px solid #eee;
        }
        .song-section {
            margin-bottom: 20px;
        }
        .song-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        .song-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .song-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .song-item:hover {
            background: #e9ecef;
            border-color: #2196F3;
        }
        .song-item.selected {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        .song-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .song-description {
            color: #666;
            font-size: 14px;
        }
        .upload-placeholder {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            padding: 20px;
            text-align: center;
            color: #666;
        }
        .upload-placeholder ul {
            text-align: left;
            max-width: 300px;
            margin: 10px auto;
        }
        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
        }
        .volume-control {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
            text-align: center;
        }
        .volume-control label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }
        .volume-slider-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        .volume-slider {
            width: 300px;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .volume-slider:hover {
            opacity: 1;
        }
        .volume-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
        }
        .volume-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            cursor: pointer;
            border: none;
        }
        #volume-display {
            font-weight: bold;
            color: #2196F3;
            font-size: 18px;
            min-width: 50px;
        }
        .volume-presets {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        .volume-preset {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            color: #495057;
        }
        .volume-preset:hover {
            background: #e9ecef;
            border-color: #2196F3;
        }
        .volume-preset.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }
        .volume-info {
            margin-top: 8px;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        #servo-position {
            color: #2196F3;
            font-weight: bold;
        }
        .pathing-option-modal {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        .pathing-checkbox-modal {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .pathing-checkbox-modal input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .pathing-info-modal {
            margin-top: 8px;
            color: #666;
        }
        .midi-upload-section {
            margin-top: 15px;
        }
        .file-upload-area {
            margin-bottom: 20px;
        }
        .upload-dropzone {
            border: 2px dashed #2196F3;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8f9fa;
        }
        .upload-dropzone:hover {
            border-color: #1976D2;
            background: #e3f2fd;
        }
        .upload-dropzone.dragover {
            border-color: #4CAF50;
            background: #e8f5e8;
        }
        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        .upload-text {
            color: #333;
        }
        .uploaded-files-list {
            margin-top: 20px;
        }
        .file-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .file-info {
            flex: 1;
        }
        .file-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .file-details {
            font-size: 12px;
            color: #666;
        }
        .file-actions {
            display: flex;
            gap: 8px;
        }
        .file-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }
        .file-btn.process {
            background: #2196F3;
            color: white;
        }
        .file-btn.process:hover {
            background: #1976D2;
        }
        .file-btn.play {
            background: #4CAF50;
            color: white;
        }
        .file-btn.play:hover {
            background: #45a049;
        }
        .file-btn.delete {
            background: #f44336;
            color: white;
        }
        .file-btn.delete:hover {
            background: #d32f2f;
        }
        .file-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .processing-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Monica Robotic Harmonica Control</h1>
        
        <div id="connection-status" class="connection-status disconnected">
            Connecting to Monica...
        </div>
        
        <div class="status-bar">
            <div>
                <strong>Position:</strong> <span id="position">-</span> |
                <strong>Volume:</strong> <span id="volume">-</span>% |
                <strong>Fingers:</strong> <span id="finger-status">-</span>
            </div>
            <div>
                <strong>Memory:</strong> <span id="memory">-</span> bytes
            </div>
        </div>
        
        <div class="volume-control">
            <label for="volume-slider">üîä Volume Control:</label>
            <div class="volume-slider-container">
                <input type="range" id="volume-slider" min="0" max="100" value="50" class="volume-slider">
                <span id="volume-display">50%</span>
            </div>
            <div class="volume-info">
                <small>Volume range: 0% ‚Üí silence, 100% ‚Üí maximum usable (mapped to 20-60% servo on Pico)</small>
            </div>
            <div class="volume-presets" id="volume-presets">
                <!-- Volume presets will be loaded here -->
            </div>
        </div>
        
        <div class="controls">
            <button class="btn performance" onclick="showSongMenu()">üéµ Select & Play Song</button>
            <button class="btn" onclick="moveCart(-1)">‚Üê Left</button>
            <button class="btn" onclick="moveCart(1)">Right ‚Üí</button>
            <button class="btn" onclick="changeVolume(1)">üîä Vol+10%</button>
            <button class="btn" onclick="changeVolume(-1)">üîâ Vol-10%</button>
            <button class="btn home" onclick="homeAll()">üè† Home All</button>
        </div>
        
        
        <!-- Song Selection Modal -->
        <div id="song-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üéµ Select Performance Song</h2>
                    <span class="close" onclick="closeSongMenu()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="song-section">
                        <h3>üìÄ Preloaded Songs</h3>
                        <div id="song-list" class="song-list">
                            <div class="loading">Loading songs...</div>
                        </div>
                    </div>
                    
                    <div class="song-section">
                        <h3>‚öôÔ∏è Performance Options</h3>
                        <div class="pathing-option-modal">
                            <label class="pathing-checkbox-modal">
                                <input type="checkbox" id="local-pathing-modal" checked>
                                <span class="checkmark-modal"></span>
                                Process song pathing locally (faster performance, selected by default)
                            </label>
                            <div class="pathing-info-modal">
                                <small>When enabled, song pathing is calculated on your computer instead of the Pico for better performance.</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="song-section">
                        <h3>üéº Upload MIDI File</h3>
                        <div class="midi-upload-section">
                            <div class="file-upload-area" id="file-upload-area">
                                <input type="file" id="midi-file-input" accept=".mid,.midi" style="display: none;">
                                <div class="upload-dropzone" onclick="document.getElementById('midi-file-input').click()">
                                    <div class="upload-icon">üìÅ</div>
                                    <div class="upload-text">
                                        <strong>Click to select MIDI file</strong><br>
                                        <small>or drag & drop .mid/.midi files here</small>
                                    </div>
                                </div>
                            </div>
                            <div id="uploaded-files" class="uploaded-files-list">
                                <!-- Uploaded files will be listed here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" onclick="closeSongMenu()">Cancel</button>
                </div>
            </div>
        </div>
        
        <div class="keyboard">
            <div class="key-row">
                <div class="key" data-finger="4" data-position="0">W</div>
                <div class="key" data-finger="4" data-position="1">E</div>
                <div class="key" data-finger="5" data-position="0">R</div>
                <div class="key" data-finger="5" data-position="1">T</div>
                <div class="key" data-finger="6" data-position="0">Y</div>
                <div class="key" data-finger="6" data-position="1">U</div>
                <div class="key" data-finger="6" data-position="1">I</div>
            </div>
            <div class="key-row">
                <div class="key" data-finger="0" data-position="0">A</div>
                <div class="key" data-finger="0" data-position="1">S</div>
                <div class="key" data-finger="1" data-position="0">D</div>
                <div class="key" data-finger="1" data-position="1">F</div>
                <div class="key" data-finger="2" data-position="0">G</div>
                <div class="key" data-finger="2" data-position="1">H</div>
                <div class="key" data-finger="3" data-position="0">J</div>
                <div class="key" data-finger="3" data-position="1">K</div>
            </div>
        </div>
        
        <div class="info-panel">
            <div class="info-box">
                <h3>Controls</h3>
                <div class="key-mapping">
                    <strong>Keys:</strong> Click keys above or use keyboard<br>
                    <strong>Movement:</strong> Arrow keys ‚Üê ‚Üí (or buttons)<br>
                    <strong>Volume:</strong> Slider (0-100%) or presets<br>
                    <strong>Fine Volume:</strong> Arrow keys ‚Üë ‚Üì (¬±10%)<br>
                    <strong>Home:</strong> Space bar (or button)<br>
                </div>
            </div>
            <div class="info-box">
                <h3>Key Mapping</h3>
                <div class="key-mapping">
                    <strong>Upper Row:</strong> W E R T Y U I<br>
                    <strong>Lower Row:</strong> A S D F G H J K<br>
                    Each key controls a specific finger position<br>
                    Left position = blow, Right position = draw
                </div>
            </div>
        </div>
        
        <div class="footer">
            <a href="/config">‚öôÔ∏è Configuration</a> | 
            Network Control System for Monica
        </div>
    </div>

    <script>
        let activeKeys = new Set();
        let connectionStatus = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            setInterval(updateStatus, 2000); // Update every 2 seconds
            setupKeyboardEvents();
            setupMouseEvents();
            setupVolumeSlider();
            loadVolumePresets();
            setupMidiUpload();
        });

        function setupKeyboardEvents() {
            document.addEventListener('keydown', function(e) {
                const key = e.key.toLowerCase();
                
                if (key === ' ') {
                    e.preventDefault();
                    homeAll();
                } else if (key === 'arrowleft') {
                    e.preventDefault();
                    moveCart(-1);
                } else if (key === 'arrowright') {
                    e.preventDefault();
                    moveCart(1);
                } else if (key === 'arrowup') {
                    e.preventDefault();
                    changeVolume(1);
                } else if (key === 'arrowdown') {
                    e.preventDefault();
                    changeVolume(-1);
                } else if (isValidKey(key) && !activeKeys.has(key)) {
                    activeKeys.add(key);
                    keyDownByLetter(key);  // Hold key down
                    updateKeyDisplay(key, true);
                }
            });

            document.addEventListener('keyup', function(e) {
                const key = e.key.toLowerCase();
                if (activeKeys.has(key)) {
                    activeKeys.delete(key);
                    keyUpByLetter(key);  // Release key
                    updateKeyDisplay(key, false);
                }
            });
        }

        function setupMouseEvents() {
            document.querySelectorAll('.key').forEach(keyElement => {
                keyElement.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    const finger = parseInt(this.dataset.finger);
                    const position = parseInt(this.dataset.position);
                    keyDown(finger, position);  // Hold key down
                    this.classList.add('active');
                });

                keyElement.addEventListener('mouseup', function(e) {
                    const finger = parseInt(this.dataset.finger);
                    keyUp(finger);  // Release key
                    this.classList.remove('active');
                });

                keyElement.addEventListener('mouseleave', function(e) {
                    const finger = parseInt(this.dataset.finger);
                    keyUp(finger);  // Release key when mouse leaves
                    this.classList.remove('active');
                });
            });
        }

        function isValidKey(key) {
            return 'asdfjkghwertyui'.includes(key);
        }

        function keyDownByLetter(key) {
            const keyMapping = {
                'a': [0, 0], 's': [0, 1], 'd': [1, 0], 'f': [1, 1],
                'g': [2, 0], 'h': [2, 1], 'j': [3, 0], 'k': [3, 1],
                'w': [4, 0], 'e': [4, 1], 'r': [5, 0], 't': [5, 1],
                'y': [6, 0], 'u': [6, 1], 'i': [6, 1]
            };
            
            if (keyMapping[key]) {
                const [finger, position] = keyMapping[key];
                keyDown(finger, position);
            }
        }

        function keyUpByLetter(key) {
            const keyMapping = {
                'a': [0, 0], 's': [0, 1], 'd': [1, 0], 'f': [1, 1],
                'g': [2, 0], 'h': [2, 1], 'j': [3, 0], 'k': [3, 1],
                'w': [4, 0], 'e': [4, 1], 'r': [5, 0], 't': [5, 1],
                'y': [6, 0], 'u': [6, 1], 'i': [6, 1]
            };
            
            if (keyMapping[key]) {
                const [finger, position] = keyMapping[key];
                keyUp(finger);
            }
        }

        function pressKeyByLetter(key) {
            const keyMapping = {
                'a': [0, 0], 's': [0, 1], 'd': [1, 0], 'f': [1, 1],
                'g': [2, 0], 'h': [2, 1], 'j': [3, 0], 'k': [3, 1],
                'w': [4, 0], 'e': [4, 1], 'r': [5, 0], 't': [5, 1],
                'y': [6, 0], 'u': [6, 1], 'i': [6, 1]
            };
            
            if (keyMapping[key]) {
                const [finger, position] = keyMapping[key];
                pressKey(finger, position);
            }
        }

        function updateKeyDisplay(key, active) {
            const keyElement = document.querySelector(`[data-key="${key.toUpperCase()}"]`);
            if (keyElement) {
                if (active) {
                    keyElement.classList.add('active');
                } else {
                    keyElement.classList.remove('active');
                }
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('position').textContent = data.position;
                    document.getElementById('volume').textContent = data.volume_percent || data.volume || 0;
                    document.getElementById('memory').textContent = data.memory.toLocaleString();
                    
                    // Update volume slider
                    const volumeSlider = document.getElementById('volume-slider');
                    const volumeDisplay = document.getElementById('volume-display');
                    const volumePercent = data.volume_percent || 0;
                    if (volumeSlider && Math.abs(volumeSlider.value - volumePercent) > 1) {
                        volumeSlider.value = volumePercent;
                        volumeDisplay.textContent = volumePercent + '%';
                    }
                    
                    // Update finger status
                    if (data.fingers) {
                        const activeCount = data.fingers.active_count || 0;
                        const allHome = data.fingers.all_home;
                        const statusText = allHome ? 
                            '‚úì All neutral' : 
                            `${activeCount} active`;
                        document.getElementById('finger-status').textContent = statusText;
                    }
                    
                    setConnectionStatus(true);
                } else {
                    setConnectionStatus(false);
                }
            } catch (error) {
                console.error('Status update failed:', error);
                setConnectionStatus(false);
            }
        }

        function setConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            if (connected !== connectionStatus) {
                connectionStatus = connected;
                if (connected) {
                    statusElement.textContent = '‚úì Connected to Monica';
                    statusElement.className = 'connection-status connected';
                } else {
                    statusElement.textContent = '‚úó Disconnected from Monica';
                    statusElement.className = 'connection-status disconnected';
                }
            }
        }

        let selectedSong = 'showcase';
        let availableSongs = {};

        async function showSongMenu() {
            document.getElementById('song-modal').style.display = 'block';
            await loadSongs();
        }

        function closeSongMenu() {
            document.getElementById('song-modal').style.display = 'none';
        }

        async function loadSongs() {
            try {
                const response = await fetch('/api/list_songs');
                const data = await response.json();
                
                if (data.success && data.songs) {
                    availableSongs = data.songs;
                    displaySongs(data.songs);
                } else {
                    document.getElementById('song-list').innerHTML = 
                        '<div class="error">Failed to load songs</div>';
                }
            } catch (error) {
                document.getElementById('song-list').innerHTML = 
                    '<div class="error">Connection error loading songs</div>';
            }
        }

        function displaySongs(songs) {
            const songList = document.getElementById('song-list');
            songList.innerHTML = '';
            
            for (const [songId, description] of Object.entries(songs)) {
                const songItem = document.createElement('div');
                songItem.className = 'song-item';
                if (songId === selectedSong) {
                    songItem.classList.add('selected');
                }
                
                songItem.innerHTML = `
                    <div class="song-name">${songId}</div>
                    <div class="song-description">${description}</div>
                `;
                
                songItem.onclick = () => selectSong(songId);
                songList.appendChild(songItem);
            }
            
            // Add start button
            const startButton = document.createElement('button');
            startButton.className = 'btn performance';
            startButton.style.marginTop = '20px';
            startButton.style.width = '100%';
            startButton.innerHTML = `‚ñ∂Ô∏è Start "${selectedSong}" Performance`;
            startButton.onclick = () => startSelectedPerformance();
            songList.appendChild(startButton);
        }

        function selectSong(songId) {
            selectedSong = songId;
            
            // Update visual selection
            document.querySelectorAll('.song-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.song-item').classList.add('selected');
            
            // Update start button text
            const startButton = document.querySelector('.song-list .btn');
            if (startButton) {
                startButton.innerHTML = `‚ñ∂Ô∏è Start "${selectedSong}" Performance`;
            }
        }

        async function startSelectedPerformance() {
            try {
                closeSongMenu();
                
                // Get the local pathing preference from modal
                const localPathing = document.getElementById('local-pathing-modal').checked;
                
                const response = await fetch('/api/start_performance', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        song: selectedSong,
                        local_pathing: localPathing
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    const pathingMethod = localPathing ? 'locally processed' : 'Pico processed';
                    alert(`Performance "${selectedSong}" started! (${pathingMethod})`);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Connection error: ' + error.message);
            }
        }

        async function startPerformance() {
            // Legacy function - start default performance
            await startSelectedPerformance();
        }

        async function keyDown(finger, position) {
            // Fire and forget for maximum speed - sustain note
            fetch('/api/key_down', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({finger: finger, position: position})
            }).catch(error => {
                console.error('Key down error:', error);
            });
        }

        async function keyUp(finger) {
            // Fire and forget for maximum speed - release note
            fetch('/api/key_up', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({finger: finger})
            }).catch(error => {
                console.error('Key up error:', error);
            });
        }

        async function pressKey(finger, position) {
            // Fire and forget for maximum speed - quick press/release (legacy)
            fetch('/api/press_key', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({finger: finger, position: position})
            }).catch(error => {
                console.error('Key press error:', error);
            });
        }

        async function moveCart(direction) {
            try {
                const response = await fetch('/api/move_cart', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({direction: direction})
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('position').textContent = data.position;
                }
            } catch (error) {
                console.error('Move error:', error);
            }
        }

        function setupVolumeSlider() {
            const volumeSlider = document.getElementById('volume-slider');
            const volumeDisplay = document.getElementById('volume-display');
            
            volumeSlider.addEventListener('input', function() {
                const volume = parseInt(this.value);
                volumeDisplay.textContent = volume + '%';
                updateVolumePresetSelection(volume);
            });
            
            volumeSlider.addEventListener('change', function() {
                const volume = parseInt(this.value);
                setVolumePercent(volume);
            });
        }


        async function loadVolumePresets() {
            try {
                const response = await fetch('/api/volume_presets');
                const data = await response.json();
                
                if (data.success && data.presets) {
                    displayVolumePresets(data.presets);
                }
            } catch (error) {
                console.error('Failed to load volume presets:', error);
            }
        }

        function displayVolumePresets(presets) {
            const presetsContainer = document.getElementById('volume-presets');
            presetsContainer.innerHTML = '';
            
            for (const [name, percent] of Object.entries(presets)) {
                const presetButton = document.createElement('button');
                presetButton.className = 'volume-preset';
                presetButton.textContent = `${name} (${percent}%)`;
                presetButton.onclick = () => setVolumePreset(name, percent);
                presetButton.dataset.percent = percent;
                presetsContainer.appendChild(presetButton);
            }
            
            // Update initial selection
            updateVolumePresetSelection(50);
        }

        function updateVolumePresetSelection(currentVolume) {
            document.querySelectorAll('.volume-preset').forEach(preset => {
                const presetVolume = parseInt(preset.dataset.percent);
                if (Math.abs(presetVolume - currentVolume) <= 2) {
                    preset.classList.add('active');
                } else {
                    preset.classList.remove('active');
                }
            });
        }

        async function setVolumePreset(name, percent) {
            console.log(`Setting volume preset: ${name} (${percent}%)`);
            
            // Update slider immediately for responsive feel
            document.getElementById('volume-slider').value = percent;
            document.getElementById('volume-display').textContent = percent + '%';
            updateVolumePresetSelection(percent);
            
            // Send to Monica
            await setVolumePercent(percent);
        }

        async function setVolumePercent(percent) {
            try {
                const response = await fetch('/api/set_volume', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({volume_percent: percent})
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('volume').textContent = data.volume_percent;
                    document.getElementById('volume-display').textContent = data.volume_percent + '%';
                }
            } catch (error) {
                console.error('Volume error:', error);
            }
        }

        async function changeVolume(direction) {
            try {
                const response = await fetch('/api/set_volume', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({direction: direction})
                });
                const data = await response.json();
                if (data.success) {
                    const volumePercent = data.volume_percent;
                    document.getElementById('volume').textContent = volumePercent;
                    document.getElementById('volume-slider').value = volumePercent;
                    document.getElementById('volume-display').textContent = volumePercent + '%';
                }
            } catch (error) {
                console.error('Volume error:', error);
            }
        }

        async function homeAll() {
            try {
                const response = await fetch('/api/home_all', {method: 'POST'});
                const data = await response.json();
                if (data.success) {
                    // Reset volume slider to 0% after homing
                    document.getElementById('volume-slider').value = 0;
                    document.getElementById('volume-display').textContent = '0%';
                    updateStatus(); // Refresh status after homing
                }
            } catch (error) {
                console.error('Home error:', error);
            }
        }

        // MIDI Upload Functions
        function setupMidiUpload() {
            const fileInput = document.getElementById('midi-file-input');
            const dropzone = document.querySelector('.upload-dropzone');
            
            // File input change handler
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop handlers
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleFileDrop);
            
            // Load existing files when modal opens
            loadUploadedFiles();
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFiles(files);
            }
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type === 'audio/midi' || file.name.toLowerCase().endsWith('.mid') || file.name.toLowerCase().endsWith('.midi')) {
                    await uploadMidiFile(file);
                } else {
                    alert(`Invalid file type: ${file.name}. Please upload .mid or .midi files.`);
                }
            }
        }

        async function uploadMidiFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch('/api/upload_midi', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    console.log('File uploaded:', data);
                    loadUploadedFiles(); // Refresh the file list
                } else {
                    alert('Upload failed: ' + data.error);
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Upload failed: ' + error.message);
            }
        }

        async function loadUploadedFiles() {
            try {
                const response = await fetch('/api/list_midi_files');
                const data = await response.json();
                
                if (data.success) {
                    displayUploadedFiles(data.files);
                } else {
                    console.error('Failed to load files:', data.error);
                }
            } catch (error) {
                console.error('Error loading files:', error);
            }
        }

        function displayUploadedFiles(files) {
            const container = document.getElementById('uploaded-files');
            
            if (files.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No MIDI files uploaded yet</div>';
                return;
            }
            
            container.innerHTML = files.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">${file.filename}</div>
                        <div class="file-details">
                            Size: ${formatFileSize(file.size)} | 
                            ${file.processed ? '‚úÖ Processed' : '‚è≥ Not processed'}
                            ${file.metadata ? ` | Duration: ${(file.metadata.duration_ms/1000).toFixed(1)}s` : ''}
                        </div>
                    </div>
                    <div class="file-actions">
                        ${!file.processed ? 
                            `<button class="file-btn process" onclick="processMidiFile('${file.filename}')">Process</button>` :
                            `<button class="file-btn play" onclick="playMidiFile('${file.filename}')">Play</button>`
                        }
                        <button class="file-btn delete" onclick="deleteMidiFile('${file.filename}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processMidiFile(filename) {
            try {
                const response = await fetch('/api/process_midi', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`MIDI file processed successfully!\n\nDuties: ${data.duty_count}\nDuration: ${(data.metadata.duration_ms/1000).toFixed(1)}s\nNotes in range: ${data.metadata.filtered_notes}/${data.metadata.original_notes}`);
                    loadUploadedFiles(); // Refresh the file list
                } else {
                    alert('Processing failed: ' + data.error);
                }
            } catch (error) {
                console.error('Processing error:', error);
                alert('Processing failed: ' + error.message);
            }
        }

        async function playMidiFile(filename) {
            try {
                closeSongMenu(); // Close the modal first
                
                const response = await fetch('/api/play_midi', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`MIDI performance "${filename}" started!`);
                } else {
                    alert('Playback failed: ' + data.error);
                }
            } catch (error) {
                console.error('Playback error:', error);
                alert('Playback failed: ' + error.message);
            }
        }

        async function deleteMidiFile(filename) {
            if (!confirm(`Are you sure you want to delete "${filename}"?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/delete_midi', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });
                
                const data = await response.json();
                if (data.success) {
                    loadUploadedFiles(); // Refresh the file list
                } else {
                    alert('Delete failed: ' + data.error);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Delete failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
